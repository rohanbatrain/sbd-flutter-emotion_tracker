name: Unified Release

on:
  push:
    branches:
      - 'v0.0.*'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout the code from the repository
      - name: Checkout code
        uses: actions/checkout@v2

      # Set up Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2

      # Install dependencies
      - name: Install dependencies
        run: flutter pub get

      # Extract release version
      - name: Extract release version
        id: extract_version
        run: |
          VERSION=$(echo ${GITHUB_REF} | sed 's/refs\/heads\///')
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      # Build Android, Linux, Web as before...

      # --- Linux release steps ---
      - name: Install GTK+ 3.0 dependencies (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev pkg-config

      - name: Build Linux version (Linux)
        run: flutter build linux --release

      - name: Copy Linux binary to AppDir
        run: cp build/linux/x64/release/bundle/emotion_tracker appimage/Emotion-Tracker.AppDir/

      - name: Copy build to AppDir
        run: cp -r build/linux/x64/release/bundle/* appimage/Emotion-Tracker.AppDir/

      # Run appimagetool with desired name
      - name: Run appimagetool with desired AppImage name
        run: |
          VERSION=$(echo ${GITHUB_REF} | sed 's/refs\/heads\///')
          ARCHITECTURE="x86_64" # Assuming architecture is x86_64; modify if needed
          NEW_NAME="Emotion-Tracker-${VERSION}-${ARCHITECTURE}.AppImage"

          # Run appimagetool and create the AppImage with the desired name
          ./appimage/appimagetool-x86_64.AppImage ./appimage/Emotion-Tracker.AppDir ./appimage/$NEW_NAME
          echo "Created AppImage: $NEW_NAME"

      # Create tar.gz archive for Linux executable
      - name: Create tar.gz archive for Linux executable
        run: |
          mkdir -p release
          tar -czvf "release/emotion_tracker-${{ env.VERSION }}.tar.gz" -C build/linux/x64/release bundle
          ls -la release

      # --- Create PR to appimage.github.io ---
      - name: Set up GitHub CLI
        run: |
          curl -sSL https://github.com/cli/cli/releases/download/v2.11.0/gh_2.11.0_linux_amd64.deb -o gh.deb
          sudo dpkg -i gh.deb
          gh auth login --with-token <<< "${{ secrets.GH_TOKEN }}"

      - name: Create Metadata File for AppImage Submission
        run: |
          echo "Adding metadata file for Emotion Tracker AppImage"
          mkdir -p appimage/data
          echo "https://github.com/yourusername/emotion_tracker/releases/download/${VERSION}/Emotion-Tracker-${VERSION}-x86_64.AppImage" > appimage/data/emotion_tracker-${{ env.VERSION }}.txt

      - name: Create PR to appimage.github.io repository
        run: |
          git clone https://github.com/appimage/appimage.github.io.git
          cd appimage.github.io
          git checkout -b add-${{ env.VERSION }}-appimage
          cp ../appimage/data/emotion_tracker-${{ env.VERSION }}.txt data/
          git add data/emotion_tracker-${{ env.VERSION }}.txt
          git commit -m "Add Emotion Tracker AppImage ${VERSION}"
          git push origin add-${{ env.VERSION }}-appimage
          gh pr create --title "Add Emotion Tracker AppImage ${VERSION}" --body "This PR adds the Emotion Tracker AppImage for version ${VERSION}" --base master --head add-${{ env.VERSION }}-appimage
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
