name: Unified Release

on:
  push:
    branches:
      - 'v0.0.*'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Checkout the code from the repository
      - name: Checkout code
        uses: actions/checkout@v2

      # Cache Flutter dependencies to speed up subsequent runs
      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      # Set up Flutter (specify an exact version compatible with emotion_tracker)
      - name: Set up Flutter
        uses: subosito/flutter-action@v2

      # Install dependencies
      - name: Install dependencies
        run: flutter pub get

      # Extract the release version from the branch name (e.g., refs/heads/v0.0.1 -> v0.0.1)
      - name: Extract release version
        id: extract_version
        run: |
          VERSION=$(echo ${GITHUB_REF} | sed 's/refs\/heads\///')
          echo "VERSION=${VERSION}" >> $GITHUB_ENV

      # Cache system dependencies (Linux specific)
      - name: Cache Linux dependencies
        uses: actions/cache@v3
        with:
          path: /usr/lib/x86_64-linux-gnu
          key: ${{ runner.os }}-linux-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-linux-

  # Run all builds concurrently using a matrix strategy
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        platform: [android, linux, web]

    steps:
      # Checkout the code from the repository
      - name: Checkout code
        uses: actions/checkout@v2

      # Cache Flutter dependencies to speed up subsequent runs
      - name: Cache Flutter dependencies
        uses: actions/cache@v3
        with:
          path: ~/.pub-cache
          key: ${{ runner.os }}-flutter-${{ hashFiles('**/pubspec.yaml') }}
          restore-keys: |
            ${{ runner.os }}-flutter-

      # Set up Flutter
      - name: Set up Flutter
        uses: subosito/flutter-action@v2

      # Install dependencies
      - name: Install dependencies
        run: flutter pub get

      # Platform-specific steps for Android, Linux, and Web
      - name: Build and Deploy for ${{ matrix.platform }}
        run: |
          if [ "${{ matrix.platform }}" == "android" ]; then
            # Generate Keystore (Android)
            keytool -genkey -v -keystore $HOME/keystore.jks -storetype JKS -keyalg RSA -keysize 2048 -validity 10000 -alias "$ANDROID_KEY_ALIAS" -dname "CN=Rohan Batra, OU=Open Source, O=Second Brain Database, L=Bidholi, ST=UK, C=IN" -storepass $ANDROID_KEYSTORE_PASSWORD -keypass $ANDROID_KEY_PASSWORD
            
            # Build APK for release (Android)
            flutter build apk --release --no-shrink

            # Build AAB for release (Android)
            flutter build appbundle --release

          elif [ "${{ matrix.platform }}" == "linux" ]; then
            # Install GTK+ 3.0 dependencies (Linux)
            sudo apt-get update
            sudo apt-get install -y libgtk-3-dev pkg-config

            # Build Linux version (Linux)
            flutter build linux --release

            # Copy Linux binary to AppDir
            cp build/linux/x64/release/bundle/emotion_tracker appimage/Emotion-Tracker.AppDir/

            # Run appimagetool
            ./appimage/appimagetool-x86_64.AppImage ./appimage/Emotion-Tracker.AppDir ./appimage/Emotion_Tracker.Appimage

          elif [ "${{ matrix.platform }}" == "web" ]; then
            # Enable Web for Flutter (Web)
            flutter config --enable-web

            # Build Flutter web app (Web)
            flutter build web --release

            # Deploy to GitHub Pages (Web)
            uses: crazy-max/ghaction-github-pages@v4.1.0
            with:
              build_dir: build/web
              repo: ${{ github.repository }}
              target_branch: gh-pages
            env:
              GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Create or Update GitHub Release
  - name: Check if Release Exists
    id: check_release
    run: |
      release_exists=$(gh release view $VERSION --json name --jq '.name' || echo "")
      if [ -z "$release_exists" ]; then
        echo "Release does not exist, creating a new one"
        echo "create=true" >> $GITHUB_ENV
      else
        echo "Release exists, updating the existing release"
        echo "create=false" >> $GITHUB_ENV
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  - name: Verify Files Exist
    id: verify_files
    run: |
      if [ -f "build/app/outputs/bundle/release/app-release.aab" ] && \
         [ -f "build/app/outputs/flutter-apk/app-release.apk" ] && \
         [ -f "appimage/Emotion_Tracker.Appimage" ] && \
         [ -f "release/emotion_tracker-${{ env.VERSION }}.tar.gz" ]; then
        echo "All files exist"
      else
        echo "One or more files do not exist"
        exit 1
      fi

  - name: Create or Update GitHub Release
    run: |
      echo "Checking if release exists..."
      release_exists=$(gh release view $VERSION --json name --jq '.name' || echo "")
      
      if [ -n "$release_exists" ]; then
        echo "Release exists, deleting the existing release..."
        gh release delete $VERSION --yes --repo $GITHUB_REPOSITORY
      else
        echo "Release does not exist, creating a new release."
      fi
      
      # Create the new release and upload the assets
      echo "Creating a new release and uploading assets..."
      gh release create $VERSION \
        build/app/outputs/bundle/release/app-release.aab \
        build/app/outputs/flutter-apk/app-release.apk \
        appimage/Emotion_Tracker.Appimage \
        release/emotion_tracker-${{ env.VERSION }}.tar.gz \
        --title "Release $VERSION" \
        --notes "Release $VERSION for branch $GITHUB_REF" \
        --repo $GITHUB_REPOSITORY
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
